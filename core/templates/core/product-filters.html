{% extends 'account/base.html' %}
{% load static %}
{% load core_filters %}

{% block title %} Product Details {% endblock %}

{% block style %}
  <style>
  .ratio-4-3 { position: relative; width: 100%; padding-top: 75%; background: #f8fafc; overflow: hidden; }
  .ratio-4-3 img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; object-position: center; transition: transform .25s ease; background:#ebebeb;}
  .ratio-4-3 img:hover { transform: scale(1.04); }
  
  /* Category hierarchy styles */
  .category-parent {
    margin-bottom: 0.5rem;
  }
  
  .category-children {
    margin-left: 1.5rem;
    margin-top: 0.5rem;
    border-left: 2px solid #e5e7eb;
    padding-left: 0.75rem;
  }
  
  .category-child {
    margin-bottom: 0.5rem;
  }
</style>

{% endblock style %}

{% block content %}

     <!-- Shop -->
    <section id="shop">
        <div class="container mx-auto">
            <!-- Top Filter -->
            <div class="flex flex-col md:flex-row justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <button
                        class="bg-primary text-white hover:bg-transparent hover:text-primary border hover:border-primary py-2 px-4 rounded-full focus:outline-none">Show
                        On
                        Sale</button>
                    <button
                        class="bg-primary text-white hover:bg-transparent hover:text-primary border hover:border-primary py-2 px-4 rounded-full focus:outline-none">List
                        View</button>
                    <button
                        class="bg-primary text-white hover:bg-transparent hover:text-primary border hover:border-primary py-2 px-4 rounded-full focus:outline-none">Grid
                        View</button>
                </div>
                <div class="flex mt-5 md:mt-0 space-x-4">
                    <div class="relative">
                        <form method="GET" id="filter-input-form" action="{% url 'product_listing' %}">
                            <!-- Preserve all filter parameters -->
                            {% for category_id in selected_categories %}
                                <input type="hidden" name="category" value="{{ category_id }}" class="filter-hidden-input">
                            {% endfor %}
                            {% for size_id in selected_sizes %}
                                <input type="hidden" name="size" value="{{ size_id }}" class="filter-hidden-input">
                            {% endfor %}
                            {% for brand_id in selected_brands %}
                                <input type="hidden" name="brand" value="{{ brand_id }}" class="filter-hidden-input">
                            {% endfor %}
                            {% for color_id in selected_colors %}
                                <input type="hidden" name="color" value="{{ color_id }}" class="filter-hidden-input">
                            {% endfor %}
                            
                            <select name="sort_by" id="filter-input"
                                class="filter-input block appearance-none w-full bg-white border  hover:border-primary px-4 py-2 pr-8 rounded-full shadow leading-tight focus:outline-none focus:shadow-outline">
                                {% with current_sort=request.GET.sort_by|default:'latest' %}
                                    <option value="latest" {% if current_sort == 'latest' %}selected{% endif %}>Sort by Latest</option>
                                    <option value="popular" {% if current_sort == 'popular' %}selected{% endif %}>Sort by Popularity</option>
                                    <option value="a_z" {% if current_sort == 'a_z' %}selected{% endif %}>Sort by A-Z</option>
                                {% endwith %}
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center justify-center px-2">
                                <img id="arrow-down" class="h-4 w-4" src="{% static 'account/assets/images/filter-down-arrow.svg' %}"
                                    alt="filter arrow">
                                <img id="arrow-up" class="h-4 w-4 hidden" src="{% static 'account/assets/images/filter-up-arrow.svg' %}"
                                    alt="filter arrow">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- Filter Toggle Button for Mobile -->
            <div class="block md:hidden text-center mb-4">
                <button id="products-toggle-filters"
                    class="bg-primary text-white py-2 px-4 rounded-full focus:outline-none">Show Filters</button>
            </div>
            <div class="flex flex-col md:flex-row">
                <!-- Filters -->
                <div id="filters" class="w-full md:w-1/4 p-4 hidden md:block">
                    <!-- Category Filter with Hierarchy -->
                    <div class="mb-6 pb-8 border-b border-gray-line">
                        <h3 class="text-lg font-semibold mb-6">Category</h3>
                        <div class="space-y-3">
                            {% if categories %}
                                {% for parent in categories %}
                                    <!-- Parent Category -->
                                    <div class="category-parent">
                                        <label class="flex items-center">
                                            <input type="checkbox" 
                                            name="category"
                                            value="{{ parent.id }}"
                                            class="filter-checkbox category-parent-checkbox form-checkbox custom-checkbox" 
                                            data-parent-id="{{ parent.id }}"
                                            {% if parent.id|stringformat:"s" in selected_categories %}checked{% endif %}>
                                            <span class="ml-2">{{ parent.name }}</span>
                                        </label>
                                        
                                        <!-- Child Categories -->
                                        {% if parent.subcategories.all %}
                                            <div class="category-children">
                                                {% for child in parent.subcategories.all %}
                                                    <div class="category-child">
                                                        <label class="flex items-center">
                                                            <input type="checkbox" 
                                                            name="category"
                                                            value="{{ child.id }}"
                                                            class="filter-checkbox category-child-checkbox form-checkbox custom-checkbox" 
                                                            data-parent-id="{{ parent.id }}"
                                                            {% if child.id|stringformat:"s" in selected_categories %}checked{% endif %}>
                                                            <span class="ml-2 text-sm">{{ child.name }}</span>
                                                        </label>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Size Filter -->
                    <div class="mb-6 pb-8 border-b border-gray-line">
                        <h3 class="text-lg font-semibold mb-6">Size</h3>
                        <div class="space-y-2">
                            {% if sizes %}
                                {% for size in sizes %}
                                <label class="flex items-center">
                                    <input type="checkbox" 
                                    name="size" 
                                    value="{{ size.id }}" 
                                    class="filter-checkbox form-checkbox custom-checkbox"
                                    {% if size.id|stringformat:"s" in selected_sizes %}checked{% endif %}>
                                    <span class="ml-2">{{ size.name }}</span>
                                </label>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Color Filter -->
                    <div class="mb-6 pb-8 border-b border-gray-line">
                        <h3 class="text-lg font-semibold mb-6">Color</h3>
                        <div class="space-y-2">
                            {% if colors %}
                                {% for color in colors %}
                                <label class="flex items-center custom-color-checkbox" data-color="{{ color.hex_code }}">
                                    <input type="checkbox"
                                    name="color"
                                    value="{{ color.id }}"
                                    class="filter-checkbox form-checkbox custom-checkbox"
                                    {% if color.id|stringformat:"s" in selected_colors %}checked{% endif %}>
                                    <span class="ml-2 p-1 text-white" style="background: {{ color.hex_code }}">{{ color.name }}</span>
                                </label>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Brand Filter -->
                    <div class="mb-6 pb-8 border-b border-gray-line">
                        <h3 class="text-lg font-semibold mb-6">Brand</h3>
                        <div class="space-y-2">
                            {% if brands %}
                                {% for brand in brands %}
                                <label class="flex items-center">
                                    <input type="checkbox"
                                    name="brand"
                                    value="{{ brand.id }}"
                                    class="filter-checkbox form-checkbox custom-checkbox"
                                    {% if brand.id|stringformat:"s" in selected_brands %}checked{% endif %}>
                                    <span class="ml-2">{{ brand.name }}</span>
                                </label>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Rating Filter -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-6">Rating</h3>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="form-checkbox custom-checkbox">
                                <span class="ml-2">★★★★★</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="form-checkbox custom-checkbox">
                                <span class="ml-2">★★★★☆</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" class="form-checkbox custom-checkbox">
                                <span class="ml-2">★★★☆☆</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Products List -->
                <div class="w-full md:w-3/4 p-4">
                    <!-- Products grid -->
                    {% if products %}
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            {% for product in products %}
                                <div class="bg-white p-4 rounded-lg shadow">
                                    <a href="{% url 'product_detail' product.id %}" class="block ratio-4-3 rounded-t-lg overflow-hidden" title="{{ product.name }}">
                                        {% if product.images.first %}
                                            <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}"
                                                class="w-full object-cover mb-4 rounded-lg h-64 bg-gray-100 object-center">
                                        {% else %}
                                            <img src="{% static 'images/no-image.png' %}" alt="No image"
                                                class="w-full object-cover mb-4 rounded-lg h-64 bg-gray-100 object-center">
                                        {% endif %}
                                    </a>
                                    <a href="{% url 'product_detail' product.id %}" class="text-lg font-semibold mb-2 block">{{ product.name }}</a>
                                    <p class="my-2 text-gray-500">{{ product.category.name }}</p>

                                    <div class="flex items-center mb-4">
                                        <span class="text-lg font-bold text-primary">
                                            ${{ product.discount_price|default:product.price }}
                                        </span>
                                        {% if product.discount_price %}
                                            <span class="text-sm line-through ml-2">${{ product.price }}</span>
                                        {% endif %}
                                    </div>

                                    <button
                                        data-url="{% url 'add_to_cart' product.id %}"
                                        class="addToCartButton bg-primary border border-transparent hover:bg-transparent hover:border-primary text-white hover:text-primary font-semibold py-2 px-4 rounded-full w-full">
                                        Add to Cart
                                    </button>
                                </div>
                            {% empty %}
                                <div class="col-span-full text-center py-10 bg-white rounded-lg shadow">
                                    <p class="text-gray-500 text-lg font-medium">No products found in this category.</p>
                                </div>
                            {% endfor %}
                    </div>

                    <!-- Pagination -->
                    {% if products.paginator.num_pages > 1 %}
                    <div class="flex justify-center mt-8">
                        <nav aria-label="Page navigation">
                            <ul class="inline-flex space-x-2">
                                {% if products.has_previous %}
                                    <li>
                                        <a href="?{{ query_string }}&page={{ products.previous_page_number }}" 
                                           class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-primary hover:text-white">Prev</a>
                                    </li>
                                {% endif %}

                                {% for num in products.paginator.page_range %}
                                    {% if num == products.number %}
                                        <li>
                                            <a href="#"
                                                class="bg-primary text-white w-10 h-10 flex items-center justify-center rounded-full">{{ num }}</a>
                                        </li>
                                    {% elif num > products.number|add:'-3' and num < products.number|add:'3' %}
                                     <li>
                                        <a href="?{{ query_string }}&page={{ num }}"
                                            class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-primary hover:text-white">{{ num }}</a>
                                    </li>
                                    {% endif %}
                                {% endfor %}
                                {% if products.has_next %}
                                    <li>
                                        <a href="?{{ query_string }}&page={{ products.next_page_number }}" 
                                           class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-primary hover:text-white">Next</a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                     {% else %}
                        <div class="col-span-full text-center py-10 bg-white rounded-lg shadow">
                            <p class="text-gray-500 text-lg font-medium">No products available at the moment.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>

    <!-- Shop category description -->
    {% if current_category %}
    <section id="shop-category-description" class="py-8">
        <div class="container mx-auto">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-4">{{ current_category.name }}</h2>
                <p class="mb-4">
                    {{ current_category.description|default:'N/A' }}
                </p>
            </div>
        </div>
    </section>
    {% endif %}

{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const sortSelect = document.getElementById('filter-input');
        const filterForm = document.getElementById('filter-input-form');
        const filterCheckboxes = document.querySelectorAll('.filter-checkbox');
        const parentCheckboxes = document.querySelectorAll('.category-parent-checkbox');
        const childCheckboxes = document.querySelectorAll('.category-child-checkbox');

        // Handle sort select change
        if (sortSelect) {
            sortSelect.addEventListener('change', function() {
                filterForm.submit();
            });
        }

        // Handle parent category checkbox changes
        parentCheckboxes.forEach(parentCheckbox => {
            parentCheckbox.addEventListener('change', function() {
                const parentId = this.dataset.parentId;
                const isChecked = this.checked;
                
                // If parent is checked, uncheck all its children
                if (isChecked) {
                    const children = document.querySelectorAll(`.category-child-checkbox[data-parent-id="${parentId}"]`);
                    children.forEach(child => {
                        child.checked = false;
                    });
                }
                
                applyFilters();
            });
        });

        // Handle child category checkbox changes
        childCheckboxes.forEach(childCheckbox => {
            childCheckbox.addEventListener('change', function() {
                const parentId = this.dataset.parentId;
                
                // If any child is checked, uncheck the parent
                if (this.checked) {
                    const parentCheckbox = document.querySelector(`.category-parent-checkbox[data-parent-id="${parentId}"]`);
                    if (parentCheckbox) {
                        parentCheckbox.checked = false;
                    }
                }
                
                applyFilters();
            });
        });

        // Handle other filter checkbox changes
        filterCheckboxes.forEach(checkbox => {
            // Skip if already handled by parent/child logic
            if (!checkbox.classList.contains('category-parent-checkbox') && 
                !checkbox.classList.contains('category-child-checkbox')) {
                checkbox.addEventListener('change', function() {
                    applyFilters();
                });
            }
        });

        function applyFilters() {
            // Use the base product listing URL (not category/brand specific URL)
            const baseUrl = "{% url 'product_listing' %}";
            const params = new URLSearchParams();

            // Get sort value
            const sortBy = document.getElementById('filter-input')?.value;
            if (sortBy) {
                params.append('sort_by', sortBy);
            }

            // Get all checked category filters (both parent and child)
            document.querySelectorAll('input[name="category"]:checked').forEach(input => {
                params.append('category', input.value);
            });

            // Get all checked size filters
            document.querySelectorAll('input[name="size"]:checked').forEach(input => {
                params.append('size', input.value);
            });

            // Get all checked brand filters
            document.querySelectorAll('input[name="brand"]:checked').forEach(input => {
                params.append('brand', input.value);
            });

            // Get all checked color filters
            document.querySelectorAll('input[name="color"]:checked').forEach(input => {
                params.append('color', input.value);
            });

            // Navigate to base URL with filters (removes category_id/brand_id from URL)
            window.location.href = baseUrl + '?' + params.toString();
        }

        // Mobile filter toggle
        const toggleFiltersBtn = document.getElementById('products-toggle-filters');
        const filtersDiv = document.getElementById('filters');

        if (toggleFiltersBtn && filtersDiv) {
            toggleFiltersBtn.addEventListener('click', function() {
                filtersDiv.classList.toggle('hidden');
                this.textContent = filtersDiv.classList.contains('hidden') ? 'Show Filters' : 'Hide Filters';
            });
        }
    });
</script>
{% endblock script %}